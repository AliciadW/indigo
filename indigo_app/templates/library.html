{% extends "main.html" %}

{% block title %}Library{% endblock %}

{% block content %}
<main id="library-view">
  <aside class="library-sidebar">
    <section>
      <select class="form-control filter-country" name="country-filter">
        {% for country in countries %}
          <option {% if user.editor.country_code == country.code %}selected{% endif %} value="{{country.code}}">{{country.name}}</option>
        {% endfor %}
      </select>
    </section>

    <div id="filters"></div>
  </aside>

  <div class="library-wrapper">
    <div class="library-filter-box">
      <input type="text" class="form-control filter-search" placeholder="Filter documents">
    </div>

    <div id="library"></div>
  </div>
</main>
{% endblock %}

{% block js %}
{{ block.super }}

<script id="search-results-template" type="text/x-handlebars-template">
{% verbatim %}

<table class="table table-condensed table-hover document-list-table sorted-table">
  <thead>
    <tr>
      <th class="title" data-sort="title">Title</th>
      <th class="year" data-sort="year">Year / Number</th>
      <th class="updated_at" data-sort="updated_at">Updated</th>
    </tr>
  </thead>
  <tbody>
    {{#each works}}
      {{#unless docs}}
        <tr>
          <!-- work without any documents -->
          <td>
            <i class="fa fa-fw fa-circle" title="empty work"></i>
            <a href="/works/{{ id }}">{{ title }}</a>
          </td>
          <td>{{ year }} / {{ number }}</td>
          <td>
            <span class="time-ago" data-timestamp="{{ updated_at }}">{{ updated_at }}</span>
            <span class="text-muted">{{#if updated_by_user.display_name}}- {{ updated_by_user.display_name }}{{/if}}</span>
          </td>
        </tr>
      {{/unless}}

      {{#each docs}}
        <tr {{#unless @first}}class="amended-version"{{/unless}}>
          <td>
            {{#if draft}}
              <i class="fa fa-fw fa-circle draft" title="draft"></i>
            {{else}}
              <i class="fa fa-fw fa-circle published" title="published"></i>
            {{/if}}

            {{#if @first}}
              <a href="/documents/{{ id }}/">{{ title }}</a>
              <span class="text-muted">as at {{ expression_date }}</span>
            {{else}}
              <a href="/documents/{{ id }}/">{{ title }} as at {{ expression_date }}</a>
            {{/if}}

            {{#if stub}}
              <span class="label label-info">stub</span>
            {{/if}}

            {{#each tags}}
              <span class="label label-default">{{this}}</span>
            {{/each}}
          </td>
          <td>{{#if @first}}{{ year }} / {{ number }}{{/if}}</td>
          <td>
            {{#if @first}}
              <span class="time-ago" data-timestamp="{{ ../updated_at }}">{{ ../updated_at }}</span>
            {{else}}
              <span class="time-ago" data-timestamp="{{ updated_at }}">{{ updated_at }}</span>
            {{/if}}
            <span class="text-muted">{{#if updated_by_user.display_name}}- {{ updated_by_user.display_name }}{{/if}}</span>
          </td>
        </tr>
      {{/each}}
    {{/each}}
  </tbody>
  <tfoot>
    <tr>
      <td class="active" colspan="5">{{ count }} works</td>
    </tr>
  </tfoot>
</table>
{% endverbatim %}

</script>

<script id="filters-template" type="text/x-handlebars-template">
{% verbatim %}

{{#if summary.show_countries}}
<section>
  <select class="form-control filter-country" name="country-filter">
    <option {{#unless filters.country}}selected{{/unless}} value="">All countries ({{ count }})</option>
    {{#each summary.countries}}
      <option {{#if active}}selected{{/if}} value="{{code}}">{{name}} ({{ count }})</option>
    {{/each}}
  </select>
</section>
{{/if}}

{{#if summary.localities}}
<section>
  <select class="form-control filter-locality" name="locality-filter">
    <option {{#unless filters.locality}}selected{{/unless}} value="">All localities ({{ count }})</option>
    {{#each summary.localities}}
      <option {{#if active}}selected{{/if}} value="{{code}}">{{name}} ({{count}})</option>
    {{/each}}
  </select>
</section>
{{/if}}

<section>
  <div class="btn-group" data-toggle="buttons">
    <label class="btn btn-default btn-sm {{#if filter_status.all}}active{{/if}}">
      <input type="radio" name="options" autocomplete="off" class="filter-status" value="all" checked>All
    </label>
    <label class="btn btn-sm {{#if filter_status.published}}btn-info active{{else}}btn-default{{/if}}">
      <input type="radio" name="options" autocomplete="off" class="filter-status" value="published"><i class="fa fa-fw fa-circle published"></i>Published
    </label>
    <label class="btn btn-sm {{#if filter_status.draft}}btn-warning active{{else}}btn-default{{/if}}">
      <input type="radio" name="options" autocomplete="off" class="filter-status" value="draft"><i class="fa fa-fw fa-circle draft"></i>Draft
    </label>
  </div>
</section>

<section class="tag-filters">
  {{#each summary.tags}}
  <a href="#" class="label {{#if active}}label-info{{else}}label-default{{/if}} filter-tag" data-tag="{{this.tag}}">{{this.tag}} <span class="badge">{{this.count}}</span></a>
  {{/each}}
</section>
{% endverbatim %}
</script>

<script type="text/javascript">
// inject country code-to-name mappings into JS
window.Indigo.countries = {{ countries_json|safe }};

// include the documents as JSON
window.Indigo.Preloads.country_code = '{{ user.editor.country_code }}';
window.Indigo.Preloads.works = {{ works_json|safe }};
window.Indigo.Preloads.library = {{ documents_json|safe }};
</script>
{% endblock %}}
