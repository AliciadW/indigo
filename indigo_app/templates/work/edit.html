{% extends "layout.html" %}

{% block title %}{% if work %}{{ work.title }}{% else %}Work{% endif %}{% endblock %}
{% block header %}<h4>{% if work %}{{ work.title }}{% else %}Create a new work{% endif %}</h4>{% endblock %}

{% block content %}
<div class="workspace-content">
  <div class="boxed-group-inner boxed-group-inner-minimal" id="edit-work-view">
    <div class="container">
      <br>

      {% if work and perms.indigo_api.can_change_work or not work and perms.indigo_api.can_create_work %}
      {% else %}
      <div class="alert alert-danger">You don't have permission to create or change a work.</div>
      {% endif %}

      <div class="panel panel-default" id="edit-work-view">
        <div class="panel-heading">
          <h3 class="panel-title">Work Details</h3>
        </div>
        <div class="panel-body">
          <div class="form-horizontal">

            <fieldset>
              <div class="form-group">
                <label for="work_title" class="col-sm-2 control-label required">Short title</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control" id="work_title" placeholder="Title" required>
                </div>
              </div>

              <div class="form-group">
                <label for="work_country" class="col-sm-2 control-label required">Country</label>
                <div class="col-sm-4">
                  <select id="work_country" class="form-control">
                    {% for opt in countries %}
                    <option value="{{ opt.country.iso.lower }}">{{ opt.country.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <label for="work_locality" class="col-sm-2 control-label">Locality</label>
                <div class="col-sm-4">
                  <select class="form-control" id="work_locality"></select>
                </div>
              </div>

              <div class="form-group">
                <label for="work_year" class="col-sm-2 control-label required">Year of introduction</label>
                <div class="col-sm-2">
                  <input type="text" class="form-control" id="work_year" required pattern="\d{4}">
                </div>
              </div>

              <div class="form-group">
                <label for="work_number" class="col-sm-2 control-label required">Number within year</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" id="work_number" required pattern="[^\s]+">
                  <p class="help-block">Number or short name that uniquely identifies this legislation within the year of introduction</p>
                </div>

                <label for="work_subtype" class="col-sm-2 control-label">Work subtype</label>
                <div class="col-sm-4">
                  <select id="work_subtype" class="form-control">
                    <option value="">(none)</option>
                    {% for subtype in subtypes %}
                    <option value="{{ subtype.abbreviation }}">{{ subtype }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="work_frbr_uri" class="col-sm-2 control-label">FRBR URI</label>
                <div class="col-sm-4">
                  <div id="work_frbr_uri" class="form-control-static"></div>
                  <p class="help-block">Uniquely identifies this work globally</p>
                </div>
              </div>
            </fieldset>

            <fieldset>
              <legend>Promulgation</legend>

              <div class="form-group">
                <label for="work_publication_date" class="col-sm-2 control-label required">Publication date</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" data-provide="datepicker" id="work_publication_date" placeholder="yyyy-mm-dd" required pattern="\d{4}-\d\d-\d\d">
                  <p class="help-block">Date when first published</p>
                </div>
              </div>

              <div class="form-group">
                <label for="work_publication_name" class="col-sm-2 control-label">Publication name</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" id="work_publication_name" list="publication_list">
                  <p class="help-block">Original publication, eg. national gazette</p>
                </div>
                <datalist id="publication_list"></datalist>

                <label for="work_publication_number" class="col-sm-2 control-label">Publication number</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" id="work_publication_number">
                  <p class="help-block">Publication's sequence number, eg. gazette number</p>
                </div>
              </div>

              <div class="form-group">
                <label for="work_commencement_date" class="col-sm-2 control-label">Commencement date</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" data-provide="datepicker" id="work_commencement_date" placeholder="yyyy-mm-dd" pattern="\d{4}-\d\d-\d\d">
                  <p class="help-block">Date when most of the work comes into force</p>
                </div>

                <label for="work_assent_date" class="col-sm-2 control-label">Assent date</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" data-provide="datepicker" id="work_assent_date" placeholder="yyyy-mm-dd" pattern="\d{4}-\d\d-\d\d">
                  <p class="help-block">Date when signed by the President</p>
                </div>
              </div>
            </fieldset>
          </div>

        </div>

        <div class="panel-footer text-right">
          {% if work and perms.indigo_api.can_change_work or not work and perms.indigo_api.can_create_work %}
          <button class="btn btn-info save" type="button">{% if work %}Save work{% else %}Create work{% endif %}</button>
          {% endif %}

          {% if work %}
            {% if not work.can_delete %}
              <p class="pull-left">This work cannot be deleted while linked documents exist.</p>
            {% elif perms.indigo_api.can_delete_work %}
              <button class="btn btn-danger delete pull-left" type="button">Delete this work</button>
            {% endif %}
          {% endif %}
        </div>
      </div>

      {% if work %}
      <!-- expressions -->
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Amended versions of this work</h3>
        </div>
        <div class="panel-body">
          <div class="work-expressions"></div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<script id="work-expressions-template" type="text/x-handlebars-template">
{% verbatim %}

<div class="amendment-expressions">
  <ol class="expression-timeline">
    {{#each expressions}}
      <li>
        <h5>
          {{ date }}
          {{#if initial}} â€” Initial publication{{/if}}
        </h5>

        {{#if amendments}}
          <ul class="amendments">
          {{#each amendments}}
            <li data-uri="{{ amending_uri }}">
              Amended by
              {{#if amending_id }}
                <a href="/documents/{{ amending_id }}">{{ amending_title }}</a>
              {{else}}
                {{ amending_title }}
              {{/if}}
            </li>
          {{/each}}
          </ul>
        {{/if}}

        <div class="document">
          {{#if document}}
            {{#if linkable}}
            <a href="/documents/{{ document.id }}">{{ document.title }}</a>
            {{else}}
            {{ document.title }}
            {{/if}}
            as at {{ date }}
          {{else}}
            <span class="text-muted">No editable version at this date</span>
          {{/if}}
        </div>
      </li>
    {{/each}}
    <li>
      <a href="/documents/new/?frbr_uri={{ work.frbr_uri }}" class="btn btn-default"><i class="fa fa-plus"></i> Create a blank document for this work</a>
    </li>
    <li>
      <a href="/documents/import/?frbr_uri={{ work.frbr_uri }}" class="btn btn-default"><i class="fa fa-cloud-upload"></i> Import a new document for this work</a>
    </li>
  </ol>
</div>

{% endverbatim %}
</script>
{% endblock %}

{% block js %}
  {{ block.super }}

  {# include the document as JSON #}
  <script type="text/javascript">
  // inject country code-to-name mappings into JS
  window.Indigo.countries = {{ countries_json|safe }};
  window.Indigo.Preloads.country_code = '{{ user.editor.country_code }}';
  window.Indigo.Preloads.country = {{ countries_json|safe }};
  window.Indigo.Preloads.work = {{ work_json|safe }};
  </script>

{% endblock %}
